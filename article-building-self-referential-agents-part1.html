<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Learn to build self-referential AI code agents using .NET 10, Ollama native tool calling, Microsoft.Extensions.AI, and Aspire orchestration. Production-ready tutorial for the PMCR-O framework.">
    <meta name="author" content="Shawn Delaine Bellazan">
    <meta name="keywords" content=".NET 10, Aspire, Ollama, AI Agents, Self-Referential Systems, PMCR-O, Tool Calling, Microsoft.Extensions.AI, OllamaSharp, Code Generation">
    <meta name="google-site-verification" content="UdKSEhF53U7UM_M7tJ1jzITrxm5OrgypZyEDoSuUhtQ" />
    <meta name="theme-color" content="#d4a574">

    <!-- Favicons -->
    <link rel="icon" href="assets/favicon/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="assets/images/logo.png" type="image/png">

    <!-- Open Graph -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://shawndelainebellazan.com/article-building-self-referential-agents-part1.html">
    <meta property="og:title" content="Building Self-Referential Agents with .NET 10 & Aspire ‚Äî Part 1 | Shawn Bellazan">
    <meta property="og:description" content="Learn to build self-referential AI code agents using .NET 10, Ollama native tool calling, Microsoft.Extensions.AI, and Aspire orchestration.">
    <meta property="og:image" content="https://shawndelainebellazan.com/assets/images/og-image.svg">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Building Self-Referential Agents ‚Äî Part 1">
    <meta name="twitter:description" content="Production-ready tutorial for the PMCR-O framework using .NET 10, Ollama tool calling, and Aspire.">
    <meta name="twitter:image" content="https://shawndelainebellazan.com/assets/images/og-image.svg">

    <title>Building Self-Referential Agents with .NET 10 & Aspire ‚Äî Part 1 | Shawn Bellazan</title>
    
    <!-- Schema.org TechArticle -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "TechArticle",
      "@id": "https://shawndelainebellazan.com/article-building-self-referential-agents-part1#article",
      "headline": "Building Self-Referential Agents with .NET 10 ‚Äî Part 1: The Infrastructure of Intent",
      "description": "Complete tutorial for building production-ready self-referential AI agents using .NET 10, Ollama native tool calling, and modern AI abstractions.",
      "author": {
        "@type": "Person",
        "@id": "https://shawndelainebellazan.com/#person",
        "name": "Shawn Delaine Bellazan",
        "jobTitle": "Resilient Architect",
        "url": "https://shawndelainebellazan.com"
      },
      "datePublished": "2025-01-27",
      "dateModified": "2025-01-27",
      "publisher": {
        "@type": "Organization",
        "name": "Tooensure LLC",
        "url": "https://tooensure.com"
      },
      "dependencies": ".NET 10, Ollama, Microsoft.Extensions.AI, OllamaSharp, Aspire",
      "proficiencyLevel": "Intermediate",
      "articleBody": "Welcome to Part 1 of our journey building a self-referential agent system. By the end of this tutorial, you'll have a running .NET 10 + Aspire infrastructure...",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://shawndelainebellazan.com/article-building-self-referential-agents-part1"
      }
    }
    </script>
    
    <link rel="canonical" href="https://shawndelainebellazan.com/article-building-self-referential-agents-part1.html">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    
    <!-- Portfolio CSS -->
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Article-specific enhancements */
        .article-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 6rem 2rem 4rem;
        }
        
        .article-header {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid rgba(212, 165, 116, 0.3);
        }
        
        .article-title {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 900;
            color: var(--gold);
            line-height: 1.2;
            margin-bottom: 1rem;
            letter-spacing: -1px;
        }
        
        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.95rem;
            margin-top: 1rem;
        }
        
        .article-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .article-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-secondary);
        }
        
        .article-content h2 {
            font-size: 2rem;
            color: var(--gold);
            margin: 3rem 0 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(212, 165, 116, 0.2);
        }
        
        .article-content h3 {
            font-size: 1.5rem;
            color: var(--gold-light);
            margin: 2rem 0 1rem;
        }
        
        .article-content p {
            margin-bottom: 1.5rem;
        }
        
        .article-content strong {
            color: var(--text-primary);
            font-weight: 700;
        }
        
        .article-content em {
            color: var(--gold-light);
            font-style: italic;
        }
        
        .article-content ul,
        .article-content ol {
            margin: 1.5rem 0 1.5rem 2rem;
        }
        
        .article-content li {
            margin-bottom: 0.75rem;
            line-height: 1.7;
        }
        
        .code-block-wrapper {
            position: relative;
            margin: 2rem 0;
            background: var(--gray);
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--light-gray);
        }
        
        .code-language {
            color: var(--gold);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .copy-button {
            padding: 0.4rem 1rem;
            font-size: 0.8rem;
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            cursor: pointer;
            border-radius: 4px;
            transition: all var(--transition-fast);
            font-weight: 600;
        }
        
        .copy-button:hover {
            background: var(--gold);
            color: var(--darker);
        }
        
        .copy-button.copied {
            background: #4caf50;
            border-color: #4caf50;
            color: white;
        }
        
        pre[class*="language-"] {
            margin: 0;
            border-radius: 0 0 8px 8px;
        }
        
        .callout {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.1) 0%, rgba(212, 165, 116, 0.05) 100%);
            border-left: 4px solid var(--gold);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 8px;
        }
        
        .callout-title {
            color: var(--gold);
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .architecture-diagram {
            background: var(--gray);
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
            font-family: monospace;
            color: var(--gold);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            background: rgba(0, 0, 0, 0.2);
        }
        
        th, td {
            padding: 1rem;
            border: 1px solid var(--light-gray);
            text-align: left;
        }
        
        th {
            background: rgba(212, 165, 116, 0.1);
            color: var(--gold);
            font-weight: 700;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gold);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 2rem;
            transition: all var(--transition-base);
        }
        
        .back-link:hover {
            color: var(--text-primary);
            transform: translateX(-5px);
        }
        
        .series-nav {
            background: var(--gray);
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            padding: 2rem;
            margin: 3rem 0;
            text-align: center;
        }
        
        .series-nav-title {
            color: var(--gold);
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .series-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
        }
        
        .series-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .series-link:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        
        .series-link.active {
            background: rgba(212, 165, 116, 0.1);
            border-color: var(--gold);
            color: var(--gold);
            font-weight: 700;
        }
        /* === SKIP LINK (Accessibility) === */
        .skip-link {
            position: absolute;
            top: -100px;
            left: 0;
            background: var(--gold);
            color: var(--darker);
            padding: 1rem 2rem;
            text-decoration: none;
            font-weight: 700;
            z-index: 10000;
            transition: top 0.2s ease;
            border-radius: 0 0 4px 0;
        }
        
        .skip-link:focus {
            top: 0;
        }
        
        /* === GLOBAL SCROLLBAR STYLING (2025 Design System) === */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(212, 165, 116, 0.3) transparent;
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(212, 165, 116, 0.3);
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 165, 116, 0.5);
            background-clip: padding-box;
        }
        
        ::-webkit-scrollbar-thumb:active {
            background: rgba(212, 165, 116, 0.7);
            background-clip: padding-box;
        }
    </style>
</head>
<body>
    <!-- Skip Link (Accessibility) -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Navigation -->
    <nav role="navigation" aria-label="Main navigation">
        <div class="container">
            <a href="index.html" class="logo" aria-label="Shawn Bellazan - Home">SHAWN BELLAZAN</a>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#work">Work</a></li>
                <li><a href="pmcro-codex.html">PMCR-O</a></li>
                <li><a href="pmcro-prompt-library.html">Agents</a></li>
                <li><a href="articles.html">Articles</a></li>
                <li><a href="index.html#contact">Contact</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Article -->
    <main id="main-content" class="article-container">
        <a href="index.html#work" class="back-link">
            <span>‚Üê</span> Back to Portfolio
        </a>
        
        <article>
            <header class="article-header">
                <h1 class="article-title">Building Self-Referential Agents with .NET 10 & Aspire</h1>
                <p style="font-size: 1.3rem; color: var(--gold-light); font-style: italic; margin-top: 0.5rem;">
                    Part 1: The Infrastructure of Intent (January 2025 Edition)
                </p>
                <div class="article-meta">
                    <div class="article-meta-item">
                        <span>üìÖ</span>
                        <span>December 30, 2025</span>
                    </div>
                    <div class="article-meta-item">
                        <span>‚è±Ô∏è</span>
                        <span>15 min read</span>
                    </div>
                    <div class="article-meta-item">
                        <span>üè∑Ô∏è</span>
                        <span>.NET 10 ‚Ä¢ Ollama ‚Ä¢ Aspire</span>
                    </div>
                </div>
            </header>

            <div class="article-content">
                <div class="callout">
                    <p><strong>Series:</strong> From Prototype to Production - Building the PMCR-O Framework<br>
                    <strong>Author:</strong> Refactoring Tutorial Agent<br>
                    <strong>Target Audience:</strong> Senior .NET developers interested in local AI agents</p>
                </div>

                <h2>Introduction</h2>
                <p>Welcome to <strong>Part 1</strong> of our journey building a self-referential agent system. By the end of this tutorial, you'll have:</p>
                <ul>
                    <li>A running .NET 10 + Aspire infrastructure</li>
                    <li>Ollama configured with GPU support</li>
                    <li>Your first AI agent (The Planner) that outputs <strong>structured JSON</strong> natively</li>
                    <li>A working understanding of why we do things this way</li>
                </ul>

                <h3>What makes this different from other tutorials?</h3>
                <p>Most AI agent tutorials show you how to build a chatbot. We're building something more ambitious: <strong>an agent that plans software, writes code, tests it, and learns from its mistakes</strong>. This is the foundation for that system.</p>

                <h2>Why This Architecture?</h2>
                <p>Before we write code, let's understand the <strong>design philosophy</strong>:</p>

                <h3>The Three Pillars</h3>
                <ol>
                    <li><strong>Local-First:</strong> We use Ollama (not OpenAI) because:
                        <ul>
                            <li>No API costs</li>
                            <li>Data privacy</li>
                            <li>Deterministic behavior for testing</li>
                            <li>You control the model lifecycle</li>
                        </ul>
                    </li>
                    <li><strong>Aspire Orchestration:</strong> We use .NET Aspire because:
                        <ul>
                            <li>Service discovery (agents find each other automatically)</li>
                            <li>Built-in observability (OpenTelemetry)</li>
                            <li>Container lifecycle management</li>
                            <li>Developer experience (one F5 to run everything)</li>
                        </ul>
                    </li>
                    <li><strong>Microsoft Agent Framework:</strong> We use this because:
                        <ul>
                            <li>Native .NET integration</li>
                            <li>Tool calling support</li>
                            <li>Workflow orchestration</li>
                            <li>Production-ready error handling</li>
                        </ul>
                    </li>
                </ol>

                <h3>The Critical Insight: "I AM" vs "You Are"</h3>
                <p><strong>This is the most important concept in this tutorial.</strong></p>
                <p>Traditional prompt engineering says: "You are a helpful assistant."</p>
                <p>We say: <strong>"I AM the Planner. I speak in first person."</strong></p>
                <p><strong>Why does this matter?</strong> When an agent speaks in first person, it develops <strong>agency</strong> ‚Äî a sense of ownership over its decisions. Research shows that LLMs perform better when they think of themselves as <em>actors</em> rather than <em>tools</em>.</p>

                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">Text</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-text">‚ùå BAD: "You are a planner. Generate a plan for the user."
‚úÖ GOOD: "I AM the Planner. I analyze requirements and create minimal viable plans."</code></pre>
                </div>

                <h2>Prerequisites</h2>
                <h3>Software Requirements</h3>
                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">Bash</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-bash"># .NET 10 SDK
dotnet --version  # Should show 10.0.x or higher

# Docker Desktop (for Ollama container)
docker --version  # Should show 20.x or higher

# Ollama (for local LLM inference)
# We'll install this via Aspire, but you can also run locally:
# ollama --version</code></pre>
                </div>

                <h3>Hardware Requirements</h3>
                <ul>
                    <li><strong>Minimum:</strong> 16GB RAM, modern CPU</li>
                    <li><strong>Recommended:</strong> 32GB RAM, NVIDIA GPU with 8GB+ VRAM</li>
                    <li><strong>Ideal:</strong> 64GB RAM, RTX 4090 or similar</li>
                </ul>
                <div class="callout">
                    <p><strong>GPU Note:</strong> Ollama can run on CPU, but it's slow (30-60s per inference). GPU reduces this to 2-5s.</p>
                </div>

                <h2>Project Setup</h2>
                
                <h3>Step 1: Create Solution Structure</h3>
                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">Bash</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-bash"># Create solution
mkdir PmcroAgents
cd PmcroAgents
dotnet new sln -n PmcroAgents

# Create projects (matching your actual PMCR-O architecture)
# AppHost - Console app with Aspire packages (or use: dotnet new aspire-apphost if available)
dotnet new console -n PmcroAgents.AppHost
dotnet new webapi -n PmcroAgents.PlannerService
dotnet new classlib -n PmcroAgents.ServiceDefaults
dotnet new classlib -n PmcroAgents.Shared

# Add projects to solution
dotnet sln add PmcroAgents.AppHost/PmcroAgents.AppHost.csproj
dotnet sln add PmcroAgents.ServiceDefaults/PmcroAgents.ServiceDefaults.csproj
dotnet sln add PmcroAgents.Shared/PmcroAgents.Shared.csproj
dotnet sln add PmcroAgents.PlannerService/PmcroAgents.PlannerService.csproj</code></pre>
                </div>

                <h3>Step 2: Install Packages</h3>
                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">Bash</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-bash"># AppHost packages
cd PmcroAgents.AppHost
dotnet add package Aspire.Hosting.AppHost
dotnet add package CommunityToolkit.Aspire.Hosting.Ollama

# PlannerService packages
cd ../PmcroAgents.PlannerService
dotnet add package Microsoft.Agents.AI
dotnet add package Microsoft.Extensions.AI
dotnet add package OllamaSharp
dotnet add package Grpc.AspNetCore

# Shared packages
cd ../PmcroAgents.Shared
dotnet add package Microsoft.Extensions.AI
dotnet add package Grpc.Tools</code></pre>
                </div>

                <h3>Step 3: Project References</h3>
                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">Bash</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-bash">cd ../PmcroAgents.PlannerService
dotnet add reference ../PmcroAgents.Shared/PmcroAgents.Shared.csproj
dotnet add reference ../PmcroAgents.ServiceDefaults/PmcroAgents.ServiceDefaults.csproj

cd ../PmcroAgents.AppHost
dotnet add reference ../PmcroAgents.PlannerService/PmcroAgents.PlannerService.csproj</code></pre>
                </div>

                <p>Your solution structure should look like this:</p>
                <div class="architecture-diagram">
<pre style="text-align: left; margin: 0;">PmcroAgents/
‚îú‚îÄ‚îÄ PmcroAgents.sln
‚îú‚îÄ‚îÄ PmcroAgents.AppHost/
‚îÇ   ‚îú‚îÄ‚îÄ Program.cs
‚îÇ   ‚îî‚îÄ‚îÄ PmcroAgents.AppHost.csproj
‚îú‚îÄ‚îÄ PmcroAgents.PlannerService/
‚îÇ   ‚îú‚îÄ‚îÄ Program.cs
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PlannerAgent.cs
‚îÇ   ‚îî‚îÄ‚îÄ PmcroAgents.PlannerService.csproj
‚îî‚îÄ‚îÄ PmcroAgents.Shared/
    ‚îú‚îÄ‚îÄ Protos/
    ‚îÇ   ‚îî‚îÄ‚îÄ agent.proto
    ‚îî‚îÄ‚îÄ PmcroAgents.Shared.csproj</pre>
                </div>

                <h2>The Aspire AppHost</h2>
                <p>The AppHost is the <strong>orchestrator</strong> of our system. It defines which services run, how they connect, and resource requirements.</p>

                <h3>Modern Aspire Configuration (2025 Standards)</h3>
                <p><code>PmcroAgents.AppHost/Program.cs</code>:</p>
                
                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">C#</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-csharp">using CommunityToolkit.Aspire.Hosting.Ollama;

var builder = DistributedApplication.CreateBuilder(args);

// ==============================================================================
// OLLAMA - LOCAL LLM SERVER
// ==============================================================================

var ollama = builder.AddOllama("ollama", port: 11434)
    .WithDataVolume()                              // Persist models between runs
    .WithLifetime(ContainerLifetime.Persistent)    // Keep container running
    .WithContainerRuntimeArgs("--gpus=all");       // Enable GPU passthrough

// ==============================================================================
// LLM MODELS - THE COUNCIL
// ==============================================================================

var qwen = ollama.AddModel("qwen2.5-coder:7b");    // The Planner

// ==============================================================================
// AGENT SERVICES
// ==============================================================================

var plannerService = builder.AddProject&lt;Projects.PmcroAgents_PlannerService&gt;("planner")
    .WithReference(ollama)
    .WaitFor(qwen);

builder.Build().Run();</code></pre>
                </div>

                <p><strong>What's happening here?</strong></p>
                <ol>
                    <li><strong>Ollama Container:</strong> Aspire automatically pulls and runs the Ollama Docker image</li>
                    <li><strong>GPU Passthrough:</strong> <code>--gpus=all</code> gives Ollama access to your NVIDIA GPU</li>
                    <li><strong>Model Pull:</strong> <code>.AddModel("qwen2.5-coder:7b")</code> downloads the model (7.4GB) on first run</li>
                    <li><strong>Service Discovery:</strong> <code>.WithReference(ollama)</code> automatically injects the Ollama connection string into PlannerService</li>
                </ol>

                <p><strong>Why qwen2.5-coder?</strong></p>
                <ul>
                    <li>Best open-source code model as of Dec 2024</li>
                    <li>7B parameters = fast inference (2-5s on GPU)</li>
                    <li>Strong tool-calling compliance</li>
                    <li>Works well with structured output</li>
                </ul>

                <h2>First Agent: The Planner</h2>

                <h3>gRPC Service Definition</h3>
                <p>First, we define the contract for agent communication. <code>PmcroAgents.Shared/Protos/agent.proto</code>:</p>

                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">Protobuf</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-protobuf">syntax = "proto3";

option csharp_namespace = "PmcroAgents.Shared.Grpc";

package agent;

service AgentService {
  rpc ExecuteTask (AgentRequest) returns (AgentResponse);
}

message AgentRequest {
  string intent = 1;
  string context_json = 2;
}

message AgentResponse {
  string content = 1;
  bool success = 2;
}</code></pre>
                </div>

                <h3>Planner Service Configuration</h3>
                <p><code>PmcroAgents.PlannerService/Program.cs</code>:</p>

                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">C#</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-csharp">using Microsoft.Extensions.AI;
using Microsoft.Extensions.Http.Resilience;
using OllamaSharp;
using PmcroAgents.PlannerService.Services;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddGrpc();

// ==============================================================================
// OLLAMA CLIENT SETUP
// ==============================================================================

var ollamaUri = builder.Configuration.GetConnectionString("ollama") 
    ?? "http://localhost:11434";
var modelId = "qwen2.5-coder:7b";

builder.Services.AddHttpClient("ollama", client =>
{
    client.BaseAddress = new Uri(ollamaUri);
    client.Timeout = Timeout.InfiniteTimeSpan;  // LLM inference can take 30s-2min on CPU
})
.AddStandardResilienceHandler(options =>
{
    options.AttemptTimeout.Timeout = TimeSpan.FromMinutes(3);
    options.TotalRequestTimeout.Timeout = TimeSpan.FromMinutes(5);
    options.Retry.MaxRetryAttempts = 2;
});

// ==============================================================================
// CHAT CLIENT REGISTRATION
// ==============================================================================

builder.Services.AddSingleton&lt;IChatClient&gt;(sp =>
{
    var httpClient = sp.GetRequiredService&lt;IHttpClientFactory&gt;().CreateClient("ollama");
    var baseClient = new OllamaApiClient(httpClient, modelId);
    
    return new ChatClientBuilder(baseClient)
        .UseFunctionInvocation()  // Enables tool calling
        .Build();
});

var app = builder.Build();

app.MapGrpcService&lt;PlannerAgent&gt;();
app.MapGet("/", () => "Planner Agent - gRPC endpoint available");

app.Run();</code></pre>
                </div>

                <h2>Native Structured Output</h2>
                <p>This is where we <strong>diverge from the prototype</strong>.</p>

                <h3>The Old Way (Golden Hammer)</h3>
                <p>The prototype used a "bracket counter" algorithm to extract JSON from text:</p>
                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">C#</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-csharp">// ‚ùå DON'T DO THIS
var jsonBlocks = ExtractJsonBlocksUsingBracketCounter(text);
foreach (var block in jsonBlocks)
{
    try { var parsed = JsonDocument.Parse(block); }
    catch { /* hope for the best */ }
}</code></pre>
                </div>

                <h3>The Modern Way (Native JSON Mode)</h3>
                <p><strong>Ollama supports structured output via JSON schema</strong>. Here's how <code>PmcroAgents.PlannerService/Services/PlannerAgent.cs</code> works:</p>

                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">C#</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-csharp">public override async Task&lt;AgentResponse&gt; ExecuteTask(
    AgentRequest request,
    ServerCallContext context)
{
    _logger.LogInformation("üß≠ I AM the Planner. I am analyzing: {Intent}", request.Intent);

    var chatOptions = new ChatOptions
    {
        // This is the magic: tell Ollama to output ONLY JSON
        ResponseFormat = ChatResponseFormat.Json,
        
        // Optional: Provide a schema for validation
        AdditionalProperties = new Dictionary&lt;string, object?&gt;
        {
            ["schema"] = JsonSerializer.Serialize(new
            {
                type = "object",
                properties = new
                {
                    plan = new { type = "string", description = "The implementation plan" },
                    steps = new
                    {
                        type = "array",
                        items = new
                        {
                            type = "object",
                            properties = new
                            {
                                action = new { type = "string" },
                                rationale = new { type = "string" }
                            }
                        }
                    },
                    estimated_complexity = new { type = "string", @enum = new[] { "low", "medium", "high" } }
                },
                required = new[] { "plan", "steps" }
            })
        }
    };
    
    // ... execution logic ...
}</code></pre>
                </div>

                <p><strong>Why is this better?</strong></p>
                <table>
                    <thead>
                        <tr>
                            <th>Aspect</th>
                            <th>Old Way (Golden Hammer)</th>
                            <th>New Way (Native JSON)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Reliability</strong></td>
                            <td>~85% success rate</td>
                            <td>~99% success rate</td>
                        </tr>
                        <tr>
                            <td><strong>Performance</strong></td>
                            <td>50-200ms parsing overhead</td>
                            <td>&lt;1ms deserialization</td>
                        </tr>
                        <tr>
                            <td><strong>Code Complexity</strong></td>
                            <td>200+ lines of parsing logic</td>
                            <td>0 lines</td>
                        </tr>
                        <tr>
                            <td><strong>Maintainability</strong></td>
                            <td>Fragile, breaks on edge cases</td>
                            <td>Robust, schema-enforced</td>
                        </tr>
                    </tbody>
                </table>

                <h2>Testing the Infrastructure</h2>
                
                <h3>Step 1: Start the System</h3>
                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">Bash</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-bash">cd PmcroAgents.AppHost
dotnet run</code></pre>
                </div>
                
                <p>Aspire dashboard launches at <code>http://localhost:15209</code>. Service discovery maps <code>ollama:11434</code> ‚Üí actual container IP.</p>

                <h3>Step 2: Test the Planner</h3>
                <p>Create a test client <code>PmcroAgents.Tests/PlannerTests.cs</code>:</p>
                
                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">C#</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-csharp">[Fact]
public async Task Planner_ShouldGenerateValidJsonPlan()
{
    // Arrange
    var channel = GrpcChannel.ForAddress("http://localhost:5106");
    var client = new AgentService.AgentServiceClient(channel);

    var request = new AgentRequest
    {
        Intent = "Create a simple console app that prints 'Hello, PMCR-O!' in C#"
    };

    // Act
    var response = await client.ExecuteTaskAsync(request);

    // Assert
    Assert.True(response.Success);
    var plan = JsonSerializer.Deserialize&lt;PlanOutput&gt;(response.Content);
    Assert.NotNull(plan);
}</code></pre>
                </div>

                <p><strong>Expected Output:</strong></p>
                <div class="code-block-wrapper">
                    <div class="code-block-header">
                        <span class="code-language">JSON</span>
                        <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    </div>
                    <pre><code class="language-json">{
  "plan": "Create a minimal C# console application using dotnet CLI",
  "steps": [
    {
      "action": "Create new console project: dotnet new console -n HelloPmcro",
      "rationale": "Minimal project structure for console output"
    },
    {
      "action": "Modify Program.cs to print message",
      "rationale": "Default template uses top-level statements, just add Console.WriteLine"
    },
    {
      "action": "Build and run: dotnet run",
      "rationale": "Verify the application works"
    }
  ],
  "estimated_complexity": "low"
}</code></pre>
                </div>

                <h2>What We Learned</h2>
                <h3>Key Takeaways</h3>
                <ol>
                    <li><strong>Native > Custom:</strong> Always prefer native LLM features over custom parsing</li>
                    <li><strong>Identity Matters:</strong> "I AM" prompts create better agent behavior</li>
                    <li><strong>Aspire Simplifies:</strong> Service discovery + observability out-of-the-box</li>
                    <li><strong>JSON Schema:</strong> Structured output is production-ready, not a hack</li>
                </ol>

                <h2>Next Steps</h2>
                <div class="series-nav">
                    <div class="series-nav-title">Tutorial Series</div>
                    <div class="series-links">
                        <a href="#" class="series-link active">Part 1: Infrastructure</a>
                        <a href="article-building-self-referential-agents-part2.html" class="series-link">Part 2: The Council</a>
                        <a href="article-building-self-referential-agents-part3.html" class="series-link">Part 3: The Strange Loop</a>
                    </div>
                </div>

                <h3>Immediate Actions</h3>
                <ul>
                    <li><strong>Run the code:</strong> Get the Planner working locally</li>
                    <li><strong>Experiment with prompts:</strong> Try different complexity levels</li>
                    <li><strong>Add logging:</strong> See what the LLM is actually doing</li>
                </ul>

                <div class="callout" style="margin: 3rem 0; text-align: center;">
                    <h3 style="color: var(--gold); margin-bottom: 1rem;">Reference Implementation</h3>
                    <p>The complete PMCR-O framework codebase is available on GitHub. Star it. Fork it. Build your own self-referential agents.</p>
                    <p style="margin-top: 1rem;">
                        <a href="https://github.com/tooensure" target="_blank" rel="noopener noreferrer" style="color: var(--gold); text-decoration: underline; font-weight: 600;">View on GitHub ‚Üí</a>
                    </p>
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-tertiary);">
                        Explore the <a href="pmcro-prompt-library.html" style="color: var(--gold);">PMCR-O Prompt Library</a> for production-ready agent templates.
                    </p>
                </div>

                <p style="text-align: center; margin-top: 3rem; font-style: italic; color: var(--text-tertiary);">
                    Happy building! üöÄ
                </p>
            </div>
        </article>
    </main>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Shawn Delaine Bellazan | Tooensure LLC</p>
        <p class="footer-tagline">Strength in vulnerability. Power in expression. Resilience in architecture.</p>
    </footer>

    <script src="site.js"></script>

    <!-- Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-protobuf.min.js"></script>

    <script>
        const hasSiteCore = typeof window !== 'undefined' && !!window.__pmcroSiteInitialized;

        // Copy code functionality
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const text = codeBlock.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        // Smooth scroll for navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // Navigation scroll effect
        if (!hasSiteCore) {
            const nav = document.querySelector('nav');
            let lastScroll = 0;

            window.addEventListener('scroll', () => {
                const currentScroll = window.pageYOffset;
                
                if (currentScroll > 100) {
                    nav.classList.add('scrolled');
                } else {
                    nav.classList.remove('scrolled');
                }
                
                lastScroll = currentScroll;
            }, { passive: true });
        }
    </script>
</body>
</html>